{% extends 'base.html' %}

{% block title %}Add New Lead{% endblock %}
{% block page_title %}Add New Lead{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <div class="bg-white rounded-4 shadow px-4 py-4 py-md-5">
                <form method="post" enctype="multipart/form-data" autocomplete="off" id="leadForm" novalidate>
                    {% csrf_token %}
                    <input type="hidden" name="submission_type" id="submissionType" value="">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="customer_id" class="form-label">Customer ID: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="customer_id" name="customer_id" required>
                            <div class="invalid-feedback">Customer ID is required.</div>
                        </div>

                        <div class="col-md-6">
                            <label for="customer_name" class="form-label">Customer Name: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="customer_name" name="customer_name" required>
                            <div class="invalid-feedback">Customer Name is required.</div>
                        </div>

                        <div class="col-md-6">
                            <label for="mobile_no" class="form-label">Mobile No: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="mobile_no" name="mobile_no" maxlength="10" required pattern="^[6-9][0-9]{9}$">
                            <div class="invalid-feedback">Please enter a valid 10-digit Indian mobile number starting with 6, 7, 8, or 9.</div>
                            <small class="text-muted">Enter 10-digit mobile number (without +91)</small>
                        </div>

                        <div class="col-md-6">
                            <label for="father_name" class="form-label">Father's Name:</label>
                            <input type="text" class="form-control" id="father_name" name="father_name">
                        </div>

                        <div class="col-md-6">
                            <label for="spouse_name" class="form-label">Spouse Name:</label>
                            <input type="text" class="form-control" id="spouse_name" name="spouse_name">
                        </div>

                        <div class="col-md-6">
                            <label for="mother_name" class="form-label">Mother's Name:</label>
                            <input type="text" class="form-control" id="mother_name" name="mother_name">
                        </div>

                        <div class="col-md-6">
                            <label for="aadhar_card_no" class="form-label">Aadhar Card No:</label>
                            <input type="text" class="form-control" id="aadhar_card_no" name="aadhar_card_no" maxlength="12" pattern="^[0-9]{12}$">
                            <div class="invalid-feedback">Aadhar number must be exactly 12 digits.</div>
                            <small class="text-muted">Enter 12-digit Aadhar number (without spaces)</small>
                        </div>

                        <div class="col-md-6">
                            <label for="pan_no" class="form-label">PAN No:</label>
                            <input type="text" class="form-control" id="pan_no" name="pan_no" maxlength="10" pattern="^[A-Z]{5}[0-9]{4}[A-Z]{1}$" style="text-transform: uppercase;">
                            <div class="invalid-feedback">PAN must be in format: ABCDE1234F (5 letters, 4 digits, 1 letter).</div>
                            <small class="text-muted">Format: ABCDE1234F</small>
                        </div>

                        <div class="col-md-6">
                            <label for="company_name" class="form-label">Company Name:</label>
                            <input type="text" class="form-control" id="company_name" name="company_name">
                        </div>

                        <div class="col-md-6">
                            <label for="email_id" class="form-label">Email ID:</label>
                            <input type="email" class="form-control" id="email_id" name="email_id" pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$">
                            <div class="invalid-feedback">Please enter a valid email address.</div>
                        </div>

                        <div class="col-md-6">
                            <label for="gst_no" class="form-label">GST No:</label>
                            <input type="text" class="form-control" id="gst_no" name="gst_no" maxlength="15" pattern="^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$" style="text-transform: uppercase;">
                            <div class="invalid-feedback">GST number must be in correct format (15 characters).</div>
                            <small class="text-muted">Format: 22AAAAA0000A1Z5</small>
                        </div>

                        <div class="col-md-6">
                            <label for="cin_no" class="form-label">CIN No:</label>
                            <input type="text" class="form-control" id="cin_no" name="cin_no" style="text-transform: uppercase;">
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-5">
                                <label for="document_name" class="form-label fw-semibold">Document Name:</label>
                                <input type="text" id="document_name" name="document_name" class="form-control" placeholder="Enter document name" value="{{ lead.document_name|default:'' }}">
                            </div>
                            <div class="col-md-5">
                                <label for="upload_document" class="form-label fw-semibold">Upload Document:</label>
                                <input type="file" id="upload_document" name="upload_document" class="form-control" accept=".pdf,.doc,.docx,.jpg,.png">
                            </div>
                            <!-- <div class="col-md-2 d-flex align-items-end gap-2">
                                <button type="submit" name="save_document" class="btn btn-primary w-100">
                                    <i class="fas fa-save me-1"></i> Save
                                </button>
                        
                                <button type="submit" name="delete_document" class="btn btn-outline-danger w-100">
                                    <i class="fas fa-trash me-1"></i> Delete
                                </button>
                            </div> -->
                        </div>
                        
                    </div>

                    <hr class="my-4">

                    <!-- Service Selection Section -->
                    <h5 class="fw-semibold mb-3">Add Services <span class="text-danger">*</span></h5>
                    <div class="row g-3 align-items-end">
                        <div class="col-md-5">
                            <label for="add_services" class="form-label">Select Service:</label>
                            <select class="form-select" id="add_services">
                                <option value="">Choose a service...</option>
                                {% for service in services %}
                                <option value="{{ service.id }}" data-price="{{ service.base_price }}" data-name="{{ service.name }}">
                                    {{ service.name }} (₹{{ service.base_price }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label for="service_price" class="form-label">Service Price:</label>
                            <input type="number" class="form-control" id="service_price" min="0" step="0.01" placeholder="0.00">
                        </div>

                        <div class="col-md-3 d-grid">
                            <button type="button" class="btn btn-primary mt-md-2" id="addServiceBtn" style="background:#035dc5; border:none;">
                                Add Service
                            </button>
                        </div>
                    </div>

                    <!-- Service Validation Error -->
                    <div id="serviceValidationError" class="text-danger mt-2" style="display: none;">
                        <small><i class="fas fa-exclamation-circle"></i> Please add at least one service.</small>
                    </div>

                    <!-- Selected Services Display -->
                    <div class="mt-3" id="selectedServicesContainer" style="display: none;">
                        <h6 class="fw-semibold">Selected Services:</h6>
                        <div id="selectedServicesList" class="mt-2"></div>
                        <div class="text-end mt-2">
                            <strong>Total Amount: ₹<span id="totalAmount">0.00</span></strong>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label for="note" class="form-label">Note:</label>
                        <textarea class="form-control" id="note" name="note" rows="3"></textarea>
                    </div>

                    <!-- Hidden input to store selected services -->
                    <input type="hidden" name="selected_services" id="selectedServicesInput">

                    <div class="mt-4 text-center">
                        <button type="submit" class="btn btn-success px-5 py-2" style="font-size:1.2rem; font-weight:600;">
                            Submit Lead
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">
                    <i class="fas fa-question-circle text-primary me-2"></i>Choose Submission Type
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="fas fa-user-plus text-success fa-3x mb-3"></i>
                    <h5>How would you like to save this entry?</h5>
                    <p class="text-muted">Customer: <strong id="confirmCustomerName"></strong></p>
                    <div class="mt-3">
                        <p class="small text-info mb-2">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Submit as Lead:</strong> Save to All Leads list for future follow-up
                        </p>
                        <p class="small text-success">
                            <i class="fas fa-check-circle me-1"></i>
                            <strong>Yes, this is Customer:</strong> Save to Customer list and All Leads
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <input type="hidden" name="selected_services" id="selectedServicesInput">
                <button type="button" class="btn btn-primary px-4" id="submitAsLeadBtn">
                    <i class="fas fa-clipboard-list me-1"></i>Submit as Lead
                </button>
                <button type="button" class="btn btn-success px-4" id="confirmCustomerBtn">
                    <i class="fas fa-user-check me-1"></i>Yes, this is Customer
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const serviceSelect = document.getElementById('add_services');
    const servicePriceInput = document.getElementById('service_price');
    const addServiceBtn = document.getElementById('addServiceBtn');
    const selectedServicesContainer = document.getElementById('selectedServicesContainer');
    const selectedServicesList = document.getElementById('selectedServicesList');
    const totalAmountSpan = document.getElementById('totalAmount');
    const selectedServicesInput = document.getElementById('selectedServicesInput');
    const serviceValidationError = document.getElementById('serviceValidationError');
    const leadForm = document.getElementById('leadForm');
    const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    const confirmCustomerName = document.getElementById('confirmCustomerName');
    const submitAsLeadBtn = document.getElementById('submitAsLeadBtn');
    const confirmCustomerBtn = document.getElementById('confirmCustomerBtn');
    const submissionTypeInput = document.getElementById('submissionType');
    
    let selectedServices = [];
    let totalAmount = 0;

    // Input validation and formatting
    const mobileInput = document.getElementById('mobile_no');
    const aadharInput = document.getElementById('aadhar_card_no');
    const panInput = document.getElementById('pan_no');
    const gstInput = document.getElementById('gst_no');
    const cinInput = document.getElementById('cin_no');

    // Mobile number validation - only numbers, max 10 digits
    mobileInput.addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
        if (this.value.length > 10) {
            this.value = this.value.slice(0, 10);
        }
        validateField(this);
    });

    // Aadhar validation - only numbers, max 12 digits
    aadharInput.addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
        if (this.value.length > 12) {
            this.value = this.value.slice(0, 12);
        }
        validateField(this);
    });

    // PAN validation - uppercase letters and numbers
    panInput.addEventListener('input', function(e) {
        this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        if (this.value.length > 10) {
            this.value = this.value.slice(0, 10);
        }
        validateField(this);
    });

    // GST validation - uppercase letters and numbers
    gstInput.addEventListener('input', function(e) {
        this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        if (this.value.length > 15) {
            this.value = this.value.slice(0, 15);
        }
        validateField(this);
    });

    // CIN validation - uppercase
    cinInput.addEventListener('input', function(e) {
        this.value = this.value.toUpperCase();
        validateField(this);
    });

    // Email validation
    document.getElementById('email_id').addEventListener('input', function(e) {
        validateField(this);
    });

    // Real-time validation function
    function validateField(field) {
        const isValid = field.checkValidity();
        if (field.value && !isValid) {
            field.classList.add('is-invalid');
            field.classList.remove('is-valid');
        } else if (field.value && isValid) {
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
        } else {
            field.classList.remove('is-invalid', 'is-valid');
        }
    }

    // Validate required fields
    function validateRequiredFields() {
        const requiredFields = ['customer_id', 'customer_name', 'mobile_no'];
        let isValid = true;

        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else if (field.checkValidity()) {
                field.classList.remove('is-invalid');
                field.classList.add('is-valid');
            } else {
                field.classList.add('is-invalid');
                isValid = false;
            }
        });

        // Validate services
        if (selectedServices.length === 0) {
            serviceValidationError.style.display = 'block';
            isValid = false;
        } else {
            serviceValidationError.style.display = 'none';
        }

        return isValid;
    }

    // Auto-fill price when service is selected
    serviceSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const price = selectedOption.getAttribute('data-price');
            servicePriceInput.value = price;
        } else {
            servicePriceInput.value = '';
        }
    });

    // Add service to the list
    addServiceBtn.addEventListener('click', function() {
        const serviceId = serviceSelect.value;
        const serviceName = serviceSelect.options[serviceSelect.selectedIndex].getAttribute('data-name');
        const servicePrice = parseFloat(servicePriceInput.value);

        if (!serviceId || !servicePrice || servicePrice <= 0) {
            alert('Please select a service and enter a valid price.');
            return;
        }

        // Check if service already added
        if (selectedServices.some(service => service.id === serviceId)) {
            alert('This service is already added.');
            return;
        }

        // Add service to array
        const service = {
            id: serviceId,
            name: serviceName,
            price: servicePrice
        };
        selectedServices.push(service);

        // Update display
        updateSelectedServicesDisplay();
        
        // Hide service validation error if services are added
        if (selectedServices.length > 0) {
            serviceValidationError.style.display = 'none';
        }
        
        // Reset form
        serviceSelect.value = '';
        servicePriceInput.value = '';
    });

    function updateSelectedServicesDisplay() {
        if (selectedServices.length === 0) {
            selectedServicesContainer.style.display = 'none';
            return;
        }

        selectedServicesContainer.style.display = 'block';
        
        let html = '';
        totalAmount = 0;

        selectedServices.forEach((service, index) => {
            totalAmount += service.price;
            html += `
                <div class="card mb-2 p-2" style="background: #f8f9fa;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${service.name}</strong>
                            <span class="text-muted">- ₹${service.price.toFixed(2)}</span>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeService(${index})">
                            Remove
                        </button>
                    </div>
                </div>
            `;
        });

        selectedServicesList.innerHTML = html;
        totalAmountSpan.textContent = totalAmount.toFixed(2);
        
        // Update hidden input
        selectedServicesInput.value = JSON.stringify(selectedServices);
    }

    // Make removeService function global
    window.removeService = function(index) {
        selectedServices.splice(index, 1);
        updateSelectedServicesDisplay();
        
        // Show validation error if no services left
        if (selectedServices.length === 0) {
            serviceValidationError.style.display = 'block';
        }
    };

    // Form submission with validation
    leadForm.addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default submission
        
        // Validate all fields
        if (!validateRequiredFields()) {
            // Scroll to first invalid field
            const firstInvalidField = document.querySelector('.is-invalid');
            if (firstInvalidField) {
                firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalidField.focus();
            }
            return;
        }

        // Validate optional fields that have values
        const optionalFieldsWithValidation = ['aadhar_card_no', 'pan_no', 'email_id', 'gst_no'];
        let hasValidationError = false;

        optionalFieldsWithValidation.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field.value && !field.checkValidity()) {
                field.classList.add('is-invalid');
                hasValidationError = true;
            }
        });

        if (hasValidationError) {
            const firstInvalidField = document.querySelector('.is-invalid');
            if (firstInvalidField) {
                firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalidField.focus();
            }
            return;
        }
        
        // Get customer name for confirmation
        const customerName = document.getElementById('customer_name').value;
        
        // Show customer name in modal
        confirmCustomerName.textContent = customerName;
        
        // Show confirmation modal
        confirmationModal.show();
    });

    // Handle "Submit as Lead" button
    submitAsLeadBtn.addEventListener('click', function() {
        // Set submission type to lead
        submissionTypeInput.value = 'lead';
        
        // Hide modal
        confirmationModal.hide();
        
        // Submit the form
        leadForm.submit();
    });

    // Handle "Yes, this is Customer" button
    confirmCustomerBtn.addEventListener('click', function() {
        // Set submission type to customer
        submissionTypeInput.value = 'customer';
        
        // Hide modal
        confirmationModal.hide();
        
        // Submit the form
        leadForm.submit();
    });

    // Add real-time validation for required fields
    ['customer_id', 'customer_name', 'mobile_no'].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        field.addEventListener('blur', function() {
            validateField(this);
        });
        field.addEventListener('input', function() {
            if (this.classList.contains('is-invalid')) {
                validateField(this);
            }
        });
    });
});
</script>

<style>
    .bg-white {
        background: #fff !important;
    }
    input, textarea, select {
        border-radius: 7px !important;
    }
    label {
        font-weight: 500;
    }
    hr {
        border-top: 1.5px solid #eee;
    }
    
    .modal-content {
        border-radius: 15px;
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .modal-header {
        border-bottom: 1px solid #eee;
        padding: 1.5rem;
    }
    
    .modal-body {
        padding: 2rem 1.5rem;
    }
    
    .modal-footer {
        border-top: 1px solid #eee;
        padding: 1.5rem;
    }

    /* Validation styles */
    .is-valid {
        border-color: #198754;
        box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
    }
    
    .is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    
    .invalid-feedback {
        display: block;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
    }
    
    .text-danger {
        color: #dc3545 !important;
    }
    
    @media (max-width: 700px) {
        .bg-white {
            padding: 16px 4vw !important;
        }
        .col-md-6, .col-md-5, .col-md-4, .col-md-3, .col-md-12 {
            flex: 0 0 100% !important;
            max-width: 100% !important;
        }
    }
</style>
{% endblock %}