{% extends 'base.html' %}

{% block title %}Edit Customer{% endblock %}
{% block page_title %}Edit Customer{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Header with Back Button -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold text-primary mb-0">
                    <i class="fas fa-user-edit me-2"></i>Edit Customer
                </h2>
                <a href="{% url 'customer' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to Customer List
                </a>
            </div>

            <div class="bg-white rounded-4 shadow px-4 py-4 py-md-5">
                <form method="post" enctype="multipart/form-data" autocomplete="off" id="editCustomerForm">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="customer_id" class="form-label">Customer ID:</label>
                            <input type="text" class="form-control" id="customer_id" name="customer_id" 
                                   value="{{ customer.customer_id }}" required>
                        </div>

                        <div class="col-md-6">
                            <label for="customer_name" class="form-label">Customer Name:</label>
                            <input type="text" class="form-control" id="customer_name" name="customer_name" 
                                   value="{{ customer.customer_name }}" required>
                        </div>

                        <div class="col-md-6">
                            <label for="mobile_no" class="form-label">Mobile No:</label>
                            <input type="text" class="form-control" id="mobile_no" name="mobile_no" 
                                   value="{{ customer.mobile_no }}" maxlength="15" required>
                        </div>

                        <div class="col-md-6">
                            <label for="father_name" class="form-label">Father's Name:</label>
                            <input type="text" class="form-control" id="father_name" name="father_name" 
                                   value="{{ customer.father_name|default:'' }}">
                        </div>

                        <div class="col-md-6">
                            <label for="spouse_name" class="form-label">Spouse Name:</label>
                            <input type="text" class="form-control" id="spouse_name" name="spouse_name" 
                                   value="{{ customer.spouse_name|default:'' }}">
                        </div>

                        <div class="col-md-6">
                            <label for="mother_name" class="form-label">Mother's Name:</label>
                            <input type="text" class="form-control" id="mother_name" name="mother_name" 
                                   value="{{ customer.mother_name|default:'' }}">
                        </div>

                        <div class="col-md-6">
                            <label for="aadhar_card_no" class="form-label">Aadhar Card No:</label>
                            <input type="text" class="form-control" id="aadhar_card_no" name="aadhar_card_no" 
                                   value="{{ customer.aadhar_card_no|default:'' }}">
                        </div>

                        <div class="col-md-6">
                            <label for="pan_no" class="form-label">PAN No:</label>
                            <input type="text" class="form-control" id="pan_no" name="pan_no" 
                                   value="{{ customer.pan_no|default:'' }}">
                        </div>

                        <div class="col-md-6">
                            <label for="company_name" class="form-label">Company Name:</label>
                            <input type="text" class="form-control" id="company_name" name="company_name" 
                                   value="{{ customer.company_name|default:'' }}">
                        </div>

                        <div class="col-md-6">
                            <label for="email_id" class="form-label">Email ID:</label>
                            <input type="email" class="form-control" id="email_id" name="email_id" 
                                   value="{{ customer.email_id|default:'' }}">
                        </div>

                        <div class="col-md-6">
                            <label for="gst_no" class="form-label">GST No:</label>
                            <input type="text" class="form-control" id="gst_no" name="gst_no" 
                                   value="{{ customer.gst_no|default:'' }}">
                        </div>

                        <div class="col-md-6">
                            <label for="cin_no" class="form-label">CIN No:</label>
                            <input type="text" class="form-control" id="cin_no" name="cin_no" 
                                   value="{{ customer.cin_no|default:'' }}">
                        </div>

                        <div class="col-md-12">
                            <label for="upload_document" class="form-label">Upload Document:</label>
                            <input type="file" class="form-control" id="upload_document" name="upload_document" 
                                   accept=".pdf,.doc,.docx,.jpg,.png">
                            {% if customer.upload_document %}
                                <small class="text-muted">Current file: {{ customer.upload_document.name }}</small>
                            {% endif %}
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Service Management Section -->
                    <h5 class="fw-semibold mb-3">Manage Services</h5>
                    <div class="row g-3 align-items-end">
                        <div class="col-md-5">
                            <label for="add_services" class="form-label">Select Service:</label>
                            <select class="form-select" id="add_services">
                                <option value="">Choose a service...</option>
                                {% for service in services %}
                                <option value="{{ service.id }}" data-price="{{ service.base_price }}" data-name="{{ service.name }}">
                                    {{ service.name }} (₹{{ service.base_price }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label for="service_price" class="form-label">Service Price:</label>
                            <input type="number" class="form-control" id="service_price" min="0" step="0.01" placeholder="0.00">
                        </div>

                        <div class="col-md-3 d-grid">
                            <button type="button" class="btn btn-primary mt-md-2" id="addServiceBtn" style="background:#035dc5; border:none;">
                                Add Service
                            </button>
                        </div>
                    </div>

                    <!-- Current Services Display -->
                    <div class="mt-3" id="selectedServicesContainer">
                        <h6 class="fw-semibold">Selected Services:</h6>
                        <div id="selectedServicesList" class="mt-2"></div>
                        <div class="text-end mt-2">
                            <strong>Total Amount: ₹<span id="totalAmount">0.00</span></strong>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label for="note" class="form-label">Note:</label>
                        <textarea class="form-control" id="note" name="note" rows="3">{{ customer.note|default:'' }}</textarea>
                    </div>

                    <!-- Hidden input to store selected services -->
                    <input type="hidden" name="selected_services" id="selectedServicesInput">

                    <div class="mt-4 d-flex gap-3 justify-content-center">
                        <button type="submit" class="btn btn-success px-5 py-2" style="font-size:1.2rem; font-weight:600;">
                            <i class="fas fa-save me-2"></i>Update Customer
                        </button>
                        <a href="{% url 'customer' %}" class="btn btn-secondary px-5 py-2" style="font-size:1.2rem; font-weight:600;">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">
                    <i class="fas fa-question-circle text-primary me-2"></i>Confirm Update
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="fas fa-user-edit text-warning fa-3x mb-3"></i>
                    <h5>Update Customer Information?</h5>
                    <p class="text-muted">Are you sure you want to update <strong id="confirmCustomerName"></strong>'s information?</p>
                    <p class="small text-info">
                        <i class="fas fa-info-circle me-1"></i>
                        This will save all changes to the customer's profile and services.
                    </p>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-success px-4" id="confirmUpdateBtn">
                    <i class="fas fa-check me-1"></i>Yes, Update Customer
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const serviceSelect = document.getElementById('add_services');
    const servicePriceInput = document.getElementById('service_price');
    const addServiceBtn = document.getElementById('addServiceBtn');
    const selectedServicesContainer = document.getElementById('selectedServicesContainer');
    const selectedServicesList = document.getElementById('selectedServicesList');
    const totalAmountSpan = document.getElementById('totalAmount');
    const selectedServicesInput = document.getElementById('selectedServicesInput');
    const editCustomerForm = document.getElementById('editCustomerForm');
    const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    const confirmCustomerName = document.getElementById('confirmCustomerName');
    const confirmUpdateBtn = document.getElementById('confirmUpdateBtn');
    
    // Initialize with current services
    let selectedServices = [];
    
    // Parse current services from backend
    try {
        const currentServices = '{{ current_services|safe }}';
        selectedServices = currentServices || [];
    } catch (e) {
        selectedServices = [];
    }
    
    // Update display on page load
    updateSelectedServicesDisplay();

    // Auto-fill price when service is selected
    serviceSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const price = selectedOption.getAttribute('data-price');
            servicePriceInput.value = price;
        } else {
            servicePriceInput.value = '';
        }
    });

    // Add service to the list
    addServiceBtn.addEventListener('click', function() {
        const serviceId = serviceSelect.value;
        const serviceName = serviceSelect.options[serviceSelect.selectedIndex].getAttribute('data-name');
        const servicePrice = parseFloat(servicePriceInput.value);

        if (!serviceId || !servicePrice || servicePrice <= 0) {
            alert('Please select a service and enter a valid price.');
            return;
        }

        // Check if service already added
        if (selectedServices.some(service => service.id === serviceId)) {
            alert('This service is already added.');
            return;
        }

        // Add service to array
        const service = {
            id: serviceId,
            name: serviceName,
            price: servicePrice
        };
        selectedServices.push(service);

        // Update display
        updateSelectedServicesDisplay();
        
        // Reset form
        serviceSelect.value = '';
        servicePriceInput.value = '';
    });

    function updateSelectedServicesDisplay() {
        if (selectedServices.length === 0) {
            selectedServicesList.innerHTML = '<p class="text-muted">No services selected</p>';
            totalAmountSpan.textContent = '0.00';
            selectedServicesInput.value = JSON.stringify([]);
            return;
        }

        let html = '';
        let totalAmount = 0;

        selectedServices.forEach((service, index) => {
            totalAmount += service.price;
            html += `
                <div class="card mb-2 p-2" style="background: #f8f9fa;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${service.name}</strong>
                            <span class="text-muted">- ₹${service.price.toFixed(2)}</span>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeService(${index})">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                </div>
            `;
        });

        selectedServicesList.innerHTML = html;
        totalAmountSpan.textContent = totalAmount.toFixed(2);
        
        // Update hidden input
        selectedServicesInput.value = JSON.stringify(selectedServices);
    }

    // Make removeService function global
    window.removeService = function(index) {
        selectedServices.splice(index, 1);
        updateSelectedServicesDisplay();
    };

    // Form submission with confirmation popup
    editCustomerForm.addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default submission
        
        // Get customer name for confirmation
        const customerName = document.getElementById('customer_name').value;
        
        if (!customerName.trim()) {
            alert('Please enter customer name');
            return;
        }
        
        // Show customer name in modal
        confirmCustomerName.textContent = customerName;
        
        // Show confirmation modal
        confirmationModal.show();
    });

    // Handle confirmation
    confirmUpdateBtn.addEventListener('click', function() {
        // Hide modal
        confirmationModal.hide();
        
        // Submit the form
        editCustomerForm.submit();
    });
});
</script>

<style>
    .bg-white {
        background: #fff !important;
    }
    
    input, textarea, select {
        border-radius: 7px !important;
    }
    
    label {
        font-weight: 500;
    }
    
    hr {
        border-top: 1.5px solid #eee;
    }
    
    .modal-content {
        border-radius: 15px;
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .modal-header {
        border-bottom: 1px solid #eee;
        padding: 1.5rem;
    }
    
    .modal-body {
        padding: 2rem 1.5rem;
    }
    
    .modal-footer {
        border-top: 1px solid #eee;
        padding: 1.5rem;
    }
    
    .card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
    }
    
    .btn-outline-danger:hover {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
    }
    
    @media (max-width: 700px) {
        .bg-white {
            padding: 16px 4vw !important;
        }
        .col-md-6, .col-md-5, .col-md-4, .col-md-3, .col-md-12 {
            flex: 0 0 100% !important;
            max-width: 100% !important;
        }
        
        .d-flex.gap-3 {
            flex-direction: column;
        }
        
        .d-flex.gap-3 .btn {
            margin-bottom: 0.5rem;
        }
    }
</style>
{% endblock %}